/* 2017-12-24 09:27:46 | 版权所有 合肥火星科技有限公司 http://www.marsgis.cn  【联系我们QQ：516584683】 */
L.widget.bindClass(L.widget.BaseWidget.extend({map:null,options:{},serverUrl:{key:["c95467d0ed2a3755836e37dc27369f97","4320dda936d909d73ab438b4e29cf2a2","e64a96ed7e361cbdc0ebaeaf3818c564","df3247b7df64434adecb876da94755d7","d4375ec477cb0a473c448fb1f83be781","13fdd7b2b90a9d326ae96867ebcc34ce","c34502450ae556f42b21760faf6695a0","57f8ebe12797a73fc5b87f5d4ef859b1"],route_bus_url:"http://restapi.amap.com/v3/direction/transit/integrated",route_car_url:"http://restapi.amap.com/v3/direction/driving"},layerWork:null,iconDot:null,create:function(){this.layerWork=L.featureGroup(),this.iconDot=L.divIcon({className:"",html:'<div style="background: #ffffff;border-radius: 50%;border: #3388ff 2px solid;width:100%;height:100%;"></div>',iconSize:[8,8]})},winCreateOK:function(t,a){},_key_index:0,getKey:function(){var t=this._key_index++%this.serverUrl.key.length;return this.serverUrl.key[t]},startMarker:null,endMarker:null,activate:function(){var t=this;this.map.addLayer(this.layerWork),this.map.contextmenu.insertItem("-",0),this.map.contextmenu.insertItem({id:"route-end",text:"清除路线规划",iconCls:"fa fa-trash-o",callback:function(a){t.clear()}},0),this.map.contextmenu.insertItem({id:"route-end",text:"设为终点",iconCls:"fa fa-flag-checkered",callback:function(a){t.addEndPoint(a.latlng),t.query()}},0),this.map.contextmenu.insertItem({id:"route-start",text:"设为起点",iconCls:"fa fa-flag-o",callback:function(a){t.addStartPoint(a.latlng),t.query()}},0)},disable:function(){this.map.removeLayer(this.layerWork),this.map.contextmenu.removeItem(0),this.map.contextmenu.removeItem(0),this.map.contextmenu.removeItem(0),this.map.contextmenu.removeItem(0)},clear:function(){this.startMarker=null,this.endMarker=null,this.layerWork.clearLayers()},addStartPoint:function(t){null!=t&&(this.startMarker=L.marker(t,{draggable:!0,icon:L.icon({iconUrl:this.path+"/img/start.png",iconSize:[30,42],iconAnchor:[15,32],popupAnchor:[0,-24],tooltipAnchor:[0,-24]})}).bindTooltip("<b>起点</b>",{className:"jsondatalayer-tooltip",direction:"top"}).addTo(this.layerWork),this.startMarker.on("moveend",this.query,this))},addEndPoint:function(t){null!=t&&(this.endMarker=L.marker(t,{draggable:!0,icon:L.icon({iconUrl:this.path+"img/end.png",iconSize:[30,42],iconAnchor:[15,32],popupAnchor:[0,-24],tooltipAnchor:[0,-24]})}).bindTooltip("<b>终点</b>",{className:"jsondatalayer-tooltip",direction:"top"}).addTo(this.layerWork),this.endMarker.on("moveend",this.query,this))},query:function(){if(null!=this.startMarker&&null!=this.endMarker){this.layerWork.clearLayers(),this.layerWork.addLayer(this.startMarker),this.layerWork.addLayer(this.endMarker);var startLatlng=this.startMarker.getLatLng(),endLatlng=this.endMarker.getLatLng(),startLatlng_wgs=this.map.convert2wgs(startLatlng),endLatlng_wgs=this.map.convert2wgs(endLatlng);startLatlng=L.mars.pointconvert.wgs2gcj([startLatlng_wgs[1],startLatlng_wgs[0]]),endLatlng=L.mars.pointconvert.wgs2gcj([endLatlng_wgs[1],endLatlng_wgs[0]]);var str_start_jwd=startLatlng[0]+","+startLatlng[1],str_end_jwd=endLatlng[0]+","+endLatlng[1],key=this.getKey();haoutil.loading.show("正在分析路线......");var $this=this;$.ajax({url:this.serverUrl.route_car_url,type:"GET",dataType:"jsonp",async:!1,timeout:"5000",contentType:"application/json;utf-8",data:{output:"json",extensions:"all",key:key,origin:str_start_jwd,destination:str_end_jwd},success:function(json){if(haoutil.loading.hide(),$this.isActivate){var data=eval(json);if(0==data.status)return void haoutil.alert("请求失败("+data.infocode+")："+data.info);if(0==data.route.paths.length)return void haoutil.msg("未查询到驾车路线！");var paths0=data.route.paths[0],info={};info.strategy=paths0.strategy,info.taxi_cost=Number(data.route.taxi_cost).toFixed(0)+"元",info.duration=haoutil.str.formatTime(paths0.duration),info.distance=haoutil.str.formatLength(paths0.distance),info.traffic_lights=paths0.traffic_lights,paths0.tolls>0&&(info.tolls=Number(paths0.tolls).toFixed(0)+"元",info.toll_distance=haoutil.str.formatLength(paths0.toll_distance)),$this.addRouteCar(paths0.steps,info)}},error:function(t){haoutil.loading.hide(),haoutil.msg("请求出错("+t.status+")："+t.statusText)}})}},objStepLine:{},addRouteCar:function(t,a){var e=this;e.objStepLine={};for(var r=[],n="",i=this.startMarker.getLatLng(),o=0;o<t.length;o++){var s=t[o];s.road&&r.indexOf(s.road)==-1&&r.push(s.road);var l=[],d=s.polyline.split(";");if($.each(d,function(t,a){var r=a.split(",");if(2==r.length){var n=Number(r[0]),i=Number(r[1]),o=L.mars.pointconvert.gcj2wgs([n,i]),s=e.map.convert2map([o[1],o[0]]);l.push(s)}}),0!=l.length){var c=L.marker(l[l.length-1],{icon:this.iconDot});e.layerWork.addLayer(c),l.insert(i,0),o==t.length-1&&l.push(this.endMarker.getLatLng()),i=l[l.length-1];var h=L.polyline(l,{color:"#3388ff",weight:5,opacity:.8}).addTo(e.layerWork),u=o+1+". "+s.instruction;h.bindTooltip(u,{className:"jsondatalayer-tooltip",direction:"top"}),e.objStepLine[o]=h,n+="<br/>&nbsp;&nbsp;&nbsp;&nbsp;"+u}}var p="<div style='font-size:14px;' >"+a.distance+" | 驾车约"+a.duration+" | 红绿灯"+a.traffic_lights+"个 | 打车约"+a.taxi_cost;a.tolls&&(p+="<br/>道路收费"+a.tolls+" | "+a.toll_distance),p+="<br/>途径："+r.join("&gt;"),p+="<br/>步骤："+n+"</div>";for(var o in e.objStepLine){var h=e.objStepLine[o];h.bindPopup(p,{maxWidth:450})}map.fitBounds(e.layerWork.getBounds())}}));